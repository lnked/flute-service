var app = app || {};

(function(body){
    "use strict";

    app = {

        _extend: function(source, config)
        {
            if (typeof config !== 'undefined')
            {
                for (var x in config)
                {
                    source[x] = config[x];
                }
            }

            return source;
        },

        bind: function()
        {
            for(var _ in this)
            {
                if (typeof(this[_]) == 'object' && typeof(this[_].init) !== 'undefined')
                {
                    if (typeof(this[_].init) == 'function')
                    {
                        this[_].init();
                    }
                }
            }
        },

        init: function()
        {
            this.bind();
        }

    };

})(document.body);
var app = app || {};

(function(body){
    "use strict";

    var _this_;

    app.modal = {

        config: {
            prefix: 'tmpl-modal-',
            trigger: '.j-open-popup'
        },

        prepare: function(selector)
        {
            var nested = [];

            if (typeof(selector) !== 'undefined' && selector.length > 1)
            {
                if (selector.substr(0, 1) == '#')
                {
                    selector = selector.substr(1);
                }

                if (selector.indexOf('/') >= 0)
                {
                    nested = selector.split('/');
                    selector = nested[0];
                }
            
                selector = _this_.config.prefix  + selector;
            }

            return selector;
        },

        _open: function(modal)
        {
            var change = modal.find('[data-change]');

            modal.addClass('is-open');
            change.addClass('is-open');
            
            setTimeout(function(){
                modal.addClass('is-animate');
                change.addClass('is-animate');
                
                autosize($(modal).find('textarea'));
            }, 10);

            $('body').trigger('modal.open', modal);
        },

        bind: function()
        {
            $('body').on('click', _this_.config.trigger, function(e){
                e.preventDefault();

                var selector = $(this).data('target') || $(this).attr('href'),
                    modal = null;

                if (document.getElementById(_this_.prepare(selector)) !== null)
                {
                    modal = $(template(_this_.prepare(selector), {}));

                    $('body').append(modal);

                    _this_._open(modal);
                }

                return !1;
            })
        },

        init: function(config)
        {
            _this_ = this;

            if (typeof config !== 'undefined')
            {
                _this_.config = app._extend(_this_.config, config);
            }

            _this_.bind();
        }

    };

})(document.body);
var app = app || {};

(function(body){
    "use strict";

    var _this_;

    app.quantity = {

        config: {
            element: '.j-quantity',
            input: '.j-quantity-count',
            control: '.j-quantity-control',
            complete: null
        },

        element: null,

        setValue: function(quantity)
        {
            var min = 1, max = 100;

            if (this.element.data('min')) {
                min = this.element.data('min');   
            }
            
            if (this.element.data('max')) {
                max = this.element.data('max');   
            }

            if (quantity > max) {
                quantity = max;
            }
            
            if (quantity < min) {
                quantity = min;
            }

            this.element.find(this.config.input).val(quantity);

        },

        increase: function(quantity)
        {
            quantity += 1;

            this.setValue(quantity);
        },

        decrease: function(quantity)
        {
            if (quantity > 1) {
                quantity -= 1;
            }

            this.setValue(quantity);
        },

        callback: function()
        {
            if (typeof(this.element.data('product')) !== 'undefined' && typeof(this.config.complete) == 'function')
            {
                this.config.complete.call(null, this.element, this.element.data('product'));
            }
        },

        keys: function()
        {
            var _this = this, role = '';

            $('body').on('keydown', _this_.config.input, function(e) {
                if ([38, 40].indexOf(e.keyCode) >= 0)
                {
                    e.preventDefault();

                    role = {
                        38: 'increase',
                        40: 'decrease'
                    };

                    _this_.element = $(this).closest(_this_.config.element);

                    _this[role[e.keyCode]](parseInt(_this_.element.find(_this_.config.input).val()));

                    _this_.callback();

                    return false;
                }
            });
        },

        bind: function()
        {
            var role = '';

            $('body').on('click', _this_.config.control, function(e) {
                e.preventDefault();

                _this_.element = $(this).closest(_this_.config.element);

                role = $(this).data('role');
         
                if(['increase', 'decrease'].indexOf(role) >= 0)
                {
                    _this[role](parseInt(_this_.element.find(_this_.config.input).val()));
                }

                _this_.callback();

                return !1;
            });
        },

        init: function(config)
        {
            _this_ = this;

            if (typeof config !== 'undefined')
            {
                _this_.config = app._extend(_this_.config, config);
            }
            
            _this_.bind();
            _this_.keys();
        }

    };

})(document.body);

// this.quantity.init({
//     complete: function(element, id) {
//         // $(element).css({
//         //     'border': '1px solid lime'
//         // });

//         console.log("id :", id);
//     }
// });

// <div class="quantity j-quantity clearfix" data-product="1000" data-min="1" data-max="999">
//     <button type="button" class="quantity__control _decrease j-quantity-control" data-role="decrease"></button>
//     <input type="text" name="count[1000]" value="1" data-role="quantity-input" class="quantity__count j-quantity-count" maxlength="3" autocomplete="off">
//     <button type="button" class="quantity__control _increase j-quantity-control" data-role="increase"></button>
// </div>
(function(callback) {
    var ready = false;

    var detach = function() {
        if(document.addEventListener) {
            document.removeEventListener("DOMContentLoaded", completed);
            window.removeEventListener("load", completed);
        } else {
            document.detachEvent("onreadystatechange", completed);
            window.detachEvent("onload", completed);
        }
    }
    var completed = function() {
        if(!ready && (document.addEventListener || event.type === "load" || document.readyState === "complete")) {
            ready = true;
            detach();
            callback();
        }
    };

    if(document.readyState === "complete") {
        callback();
    } else if(document.addEventListener) {
        document.addEventListener("DOMContentLoaded", completed);
        window.addEventListener("load", completed);
    } else {
        document.attachEvent("onreadystatechange", completed);
        window.attachEvent("onload", completed);

        var top = false;

        try {
            top = window.frameElement == null && document.documentElement;
        } catch(e) {}

        if(top && top.doScroll) {
            (function scrollCheck() {
                if(ready) return;

                try {
                    top.doScroll("left");
                } catch(e) {
                    return setTimeout(scrollCheck, 50);
                }

                ready = true;
                detach();
                callback();
            })();
        }
    }
})(function(){ app.init(); });
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIl9fYXBwLmluaXQuanMiLCJfYXBwLm1vZGFsLmpzIiwiX2FwcC5xdWFudGl0eS5qcyIsImluaXQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDekNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhcHAubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGFwcCA9IGFwcCB8fCB7fTtcblxuKGZ1bmN0aW9uKGJvZHkpe1xuICAgIFwidXNlIHN0cmljdFwiO1xuXG4gICAgYXBwID0ge1xuXG4gICAgICAgIF9leHRlbmQ6IGZ1bmN0aW9uKHNvdXJjZSwgY29uZmlnKVxuICAgICAgICB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZyAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgeCBpbiBjb25maWcpXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBzb3VyY2VbeF0gPSBjb25maWdbeF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gc291cmNlO1xuICAgICAgICB9LFxuXG4gICAgICAgIGJpbmQ6IGZ1bmN0aW9uKClcbiAgICAgICAge1xuICAgICAgICAgICAgZm9yKHZhciBfIGluIHRoaXMpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZih0aGlzW19dKSA9PSAnb2JqZWN0JyAmJiB0eXBlb2YodGhpc1tfXS5pbml0KSAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mKHRoaXNbX10uaW5pdCkgPT0gJ2Z1bmN0aW9uJylcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tfXS5pbml0KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG5cbiAgICAgICAgaW5pdDogZnVuY3Rpb24oKVxuICAgICAgICB7XG4gICAgICAgICAgICB0aGlzLmJpbmQoKTtcbiAgICAgICAgfVxuXG4gICAgfTtcblxufSkoZG9jdW1lbnQuYm9keSk7IiwidmFyIGFwcCA9IGFwcCB8fCB7fTtcblxuKGZ1bmN0aW9uKGJvZHkpe1xuICAgIFwidXNlIHN0cmljdFwiO1xuXG4gICAgdmFyIF90aGlzXztcblxuICAgIGFwcC5tb2RhbCA9IHtcblxuICAgICAgICBjb25maWc6IHtcbiAgICAgICAgICAgIHByZWZpeDogJ3RtcGwtbW9kYWwtJyxcbiAgICAgICAgICAgIHRyaWdnZXI6ICcuai1vcGVuLXBvcHVwJ1xuICAgICAgICB9LFxuXG4gICAgICAgIHByZXBhcmU6IGZ1bmN0aW9uKHNlbGVjdG9yKVxuICAgICAgICB7XG4gICAgICAgICAgICB2YXIgbmVzdGVkID0gW107XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2Yoc2VsZWN0b3IpICE9PSAndW5kZWZpbmVkJyAmJiBzZWxlY3Rvci5sZW5ndGggPiAxKVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rvci5zdWJzdHIoMCwgMSkgPT0gJyMnKVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3IgPSBzZWxlY3Rvci5zdWJzdHIoMSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKHNlbGVjdG9yLmluZGV4T2YoJy8nKSA+PSAwKVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgbmVzdGVkID0gc2VsZWN0b3Iuc3BsaXQoJy8nKTtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3IgPSBuZXN0ZWRbMF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgc2VsZWN0b3IgPSBfdGhpc18uY29uZmlnLnByZWZpeCAgKyBzZWxlY3RvcjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHNlbGVjdG9yO1xuICAgICAgICB9LFxuXG4gICAgICAgIF9vcGVuOiBmdW5jdGlvbihtb2RhbClcbiAgICAgICAge1xuICAgICAgICAgICAgdmFyIGNoYW5nZSA9IG1vZGFsLmZpbmQoJ1tkYXRhLWNoYW5nZV0nKTtcblxuICAgICAgICAgICAgbW9kYWwuYWRkQ2xhc3MoJ2lzLW9wZW4nKTtcbiAgICAgICAgICAgIGNoYW5nZS5hZGRDbGFzcygnaXMtb3BlbicpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgbW9kYWwuYWRkQ2xhc3MoJ2lzLWFuaW1hdGUnKTtcbiAgICAgICAgICAgICAgICBjaGFuZ2UuYWRkQ2xhc3MoJ2lzLWFuaW1hdGUnKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBhdXRvc2l6ZSgkKG1vZGFsKS5maW5kKCd0ZXh0YXJlYScpKTtcbiAgICAgICAgICAgIH0sIDEwKTtcblxuICAgICAgICAgICAgJCgnYm9keScpLnRyaWdnZXIoJ21vZGFsLm9wZW4nLCBtb2RhbCk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgYmluZDogZnVuY3Rpb24oKVxuICAgICAgICB7XG4gICAgICAgICAgICAkKCdib2R5Jykub24oJ2NsaWNrJywgX3RoaXNfLmNvbmZpZy50cmlnZ2VyLCBmdW5jdGlvbihlKXtcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgICAgICAgICB2YXIgc2VsZWN0b3IgPSAkKHRoaXMpLmRhdGEoJ3RhcmdldCcpIHx8ICQodGhpcykuYXR0cignaHJlZicpLFxuICAgICAgICAgICAgICAgICAgICBtb2RhbCA9IG51bGw7XG5cbiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoX3RoaXNfLnByZXBhcmUoc2VsZWN0b3IpKSAhPT0gbnVsbClcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG1vZGFsID0gJCh0ZW1wbGF0ZShfdGhpc18ucHJlcGFyZShzZWxlY3RvciksIHt9KSk7XG5cbiAgICAgICAgICAgICAgICAgICAgJCgnYm9keScpLmFwcGVuZChtb2RhbCk7XG5cbiAgICAgICAgICAgICAgICAgICAgX3RoaXNfLl9vcGVuKG1vZGFsKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gITE7XG4gICAgICAgICAgICB9KVxuICAgICAgICB9LFxuXG4gICAgICAgIGluaXQ6IGZ1bmN0aW9uKGNvbmZpZylcbiAgICAgICAge1xuICAgICAgICAgICAgX3RoaXNfID0gdGhpcztcblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBjb25maWcgIT09ICd1bmRlZmluZWQnKVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIF90aGlzXy5jb25maWcgPSBhcHAuX2V4dGVuZChfdGhpc18uY29uZmlnLCBjb25maWcpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBfdGhpc18uYmluZCgpO1xuICAgICAgICB9XG5cbiAgICB9O1xuXG59KShkb2N1bWVudC5ib2R5KTsiLCJ2YXIgYXBwID0gYXBwIHx8IHt9O1xuXG4oZnVuY3Rpb24oYm9keSl7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG5cbiAgICB2YXIgX3RoaXNfO1xuXG4gICAgYXBwLnF1YW50aXR5ID0ge1xuXG4gICAgICAgIGNvbmZpZzoge1xuICAgICAgICAgICAgZWxlbWVudDogJy5qLXF1YW50aXR5JyxcbiAgICAgICAgICAgIGlucHV0OiAnLmotcXVhbnRpdHktY291bnQnLFxuICAgICAgICAgICAgY29udHJvbDogJy5qLXF1YW50aXR5LWNvbnRyb2wnLFxuICAgICAgICAgICAgY29tcGxldGU6IG51bGxcbiAgICAgICAgfSxcblxuICAgICAgICBlbGVtZW50OiBudWxsLFxuXG4gICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbihxdWFudGl0eSlcbiAgICAgICAge1xuICAgICAgICAgICAgdmFyIG1pbiA9IDEsIG1heCA9IDEwMDtcblxuICAgICAgICAgICAgaWYgKHRoaXMuZWxlbWVudC5kYXRhKCdtaW4nKSkge1xuICAgICAgICAgICAgICAgIG1pbiA9IHRoaXMuZWxlbWVudC5kYXRhKCdtaW4nKTsgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHRoaXMuZWxlbWVudC5kYXRhKCdtYXgnKSkge1xuICAgICAgICAgICAgICAgIG1heCA9IHRoaXMuZWxlbWVudC5kYXRhKCdtYXgnKTsgICBcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHF1YW50aXR5ID4gbWF4KSB7XG4gICAgICAgICAgICAgICAgcXVhbnRpdHkgPSBtYXg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChxdWFudGl0eSA8IG1pbikge1xuICAgICAgICAgICAgICAgIHF1YW50aXR5ID0gbWluO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmVsZW1lbnQuZmluZCh0aGlzLmNvbmZpZy5pbnB1dCkudmFsKHF1YW50aXR5KTtcblxuICAgICAgICB9LFxuXG4gICAgICAgIGluY3JlYXNlOiBmdW5jdGlvbihxdWFudGl0eSlcbiAgICAgICAge1xuICAgICAgICAgICAgcXVhbnRpdHkgKz0gMTtcblxuICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZShxdWFudGl0eSk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgZGVjcmVhc2U6IGZ1bmN0aW9uKHF1YW50aXR5KVxuICAgICAgICB7XG4gICAgICAgICAgICBpZiAocXVhbnRpdHkgPiAxKSB7XG4gICAgICAgICAgICAgICAgcXVhbnRpdHkgLT0gMTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZShxdWFudGl0eSk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uKClcbiAgICAgICAge1xuICAgICAgICAgICAgaWYgKHR5cGVvZih0aGlzLmVsZW1lbnQuZGF0YSgncHJvZHVjdCcpKSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRoaXMuY29uZmlnLmNvbXBsZXRlKSA9PSAnZnVuY3Rpb24nKVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnLmNvbXBsZXRlLmNhbGwobnVsbCwgdGhpcy5lbGVtZW50LCB0aGlzLmVsZW1lbnQuZGF0YSgncHJvZHVjdCcpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcblxuICAgICAgICBrZXlzOiBmdW5jdGlvbigpXG4gICAgICAgIHtcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXMsIHJvbGUgPSAnJztcblxuICAgICAgICAgICAgJCgnYm9keScpLm9uKCdrZXlkb3duJywgX3RoaXNfLmNvbmZpZy5pbnB1dCwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgIGlmIChbMzgsIDQwXS5pbmRleE9mKGUua2V5Q29kZSkgPj0gMClcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICAgICAgICAgICAgICByb2xlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgMzg6ICdpbmNyZWFzZScsXG4gICAgICAgICAgICAgICAgICAgICAgICA0MDogJ2RlY3JlYXNlJ1xuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIF90aGlzXy5lbGVtZW50ID0gJCh0aGlzKS5jbG9zZXN0KF90aGlzXy5jb25maWcuZWxlbWVudCk7XG5cbiAgICAgICAgICAgICAgICAgICAgX3RoaXNbcm9sZVtlLmtleUNvZGVdXShwYXJzZUludChfdGhpc18uZWxlbWVudC5maW5kKF90aGlzXy5jb25maWcuaW5wdXQpLnZhbCgpKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgX3RoaXNfLmNhbGxiYWNrKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuXG4gICAgICAgIGJpbmQ6IGZ1bmN0aW9uKClcbiAgICAgICAge1xuICAgICAgICAgICAgdmFyIHJvbGUgPSAnJztcblxuICAgICAgICAgICAgJCgnYm9keScpLm9uKCdjbGljaycsIF90aGlzXy5jb25maWcuY29udHJvbCwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICAgICAgICAgIF90aGlzXy5lbGVtZW50ID0gJCh0aGlzKS5jbG9zZXN0KF90aGlzXy5jb25maWcuZWxlbWVudCk7XG5cbiAgICAgICAgICAgICAgICByb2xlID0gJCh0aGlzKS5kYXRhKCdyb2xlJyk7XG4gICAgICAgICBcbiAgICAgICAgICAgICAgICBpZihbJ2luY3JlYXNlJywgJ2RlY3JlYXNlJ10uaW5kZXhPZihyb2xlKSA+PSAwKVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgX3RoaXNbcm9sZV0ocGFyc2VJbnQoX3RoaXNfLmVsZW1lbnQuZmluZChfdGhpc18uY29uZmlnLmlucHV0KS52YWwoKSkpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIF90aGlzXy5jYWxsYmFjaygpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuICExO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sXG5cbiAgICAgICAgaW5pdDogZnVuY3Rpb24oY29uZmlnKVxuICAgICAgICB7XG4gICAgICAgICAgICBfdGhpc18gPSB0aGlzO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZyAhPT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgX3RoaXNfLmNvbmZpZyA9IGFwcC5fZXh0ZW5kKF90aGlzXy5jb25maWcsIGNvbmZpZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIF90aGlzXy5iaW5kKCk7XG4gICAgICAgICAgICBfdGhpc18ua2V5cygpO1xuICAgICAgICB9XG5cbiAgICB9O1xuXG59KShkb2N1bWVudC5ib2R5KTtcblxuLy8gdGhpcy5xdWFudGl0eS5pbml0KHtcbi8vICAgICBjb21wbGV0ZTogZnVuY3Rpb24oZWxlbWVudCwgaWQpIHtcbi8vICAgICAgICAgLy8gJChlbGVtZW50KS5jc3Moe1xuLy8gICAgICAgICAvLyAgICAgJ2JvcmRlcic6ICcxcHggc29saWQgbGltZSdcbi8vICAgICAgICAgLy8gfSk7XG5cbi8vICAgICAgICAgY29uc29sZS5sb2coXCJpZCA6XCIsIGlkKTtcbi8vICAgICB9XG4vLyB9KTtcblxuLy8gPGRpdiBjbGFzcz1cInF1YW50aXR5IGotcXVhbnRpdHkgY2xlYXJmaXhcIiBkYXRhLXByb2R1Y3Q9XCIxMDAwXCIgZGF0YS1taW49XCIxXCIgZGF0YS1tYXg9XCI5OTlcIj5cbi8vICAgICA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBjbGFzcz1cInF1YW50aXR5X19jb250cm9sIF9kZWNyZWFzZSBqLXF1YW50aXR5LWNvbnRyb2xcIiBkYXRhLXJvbGU9XCJkZWNyZWFzZVwiPjwvYnV0dG9uPlxuLy8gICAgIDxpbnB1dCB0eXBlPVwidGV4dFwiIG5hbWU9XCJjb3VudFsxMDAwXVwiIHZhbHVlPVwiMVwiIGRhdGEtcm9sZT1cInF1YW50aXR5LWlucHV0XCIgY2xhc3M9XCJxdWFudGl0eV9fY291bnQgai1xdWFudGl0eS1jb3VudFwiIG1heGxlbmd0aD1cIjNcIiBhdXRvY29tcGxldGU9XCJvZmZcIj5cbi8vICAgICA8YnV0dG9uIHR5cGU9XCJidXR0b25cIiBjbGFzcz1cInF1YW50aXR5X19jb250cm9sIF9pbmNyZWFzZSBqLXF1YW50aXR5LWNvbnRyb2xcIiBkYXRhLXJvbGU9XCJpbmNyZWFzZVwiPjwvYnV0dG9uPlxuLy8gPC9kaXY+IiwiKGZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gICAgdmFyIHJlYWR5ID0gZmFsc2U7XG5cbiAgICB2YXIgZGV0YWNoID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJET01Db250ZW50TG9hZGVkXCIsIGNvbXBsZXRlZCk7XG4gICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImxvYWRcIiwgY29tcGxldGVkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmRldGFjaEV2ZW50KFwib25yZWFkeXN0YXRlY2hhbmdlXCIsIGNvbXBsZXRlZCk7XG4gICAgICAgICAgICB3aW5kb3cuZGV0YWNoRXZlbnQoXCJvbmxvYWRcIiwgY29tcGxldGVkKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgY29tcGxldGVkID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmKCFyZWFkeSAmJiAoZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lciB8fCBldmVudC50eXBlID09PSBcImxvYWRcIiB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSBcImNvbXBsZXRlXCIpKSB7XG4gICAgICAgICAgICByZWFkeSA9IHRydWU7XG4gICAgICAgICAgICBkZXRhY2goKTtcbiAgICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgaWYoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gXCJjb21wbGV0ZVwiKSB7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgfSBlbHNlIGlmKGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIpIHtcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIkRPTUNvbnRlbnRMb2FkZWRcIiwgY29tcGxldGVkKTtcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJsb2FkXCIsIGNvbXBsZXRlZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZG9jdW1lbnQuYXR0YWNoRXZlbnQoXCJvbnJlYWR5c3RhdGVjaGFuZ2VcIiwgY29tcGxldGVkKTtcbiAgICAgICAgd2luZG93LmF0dGFjaEV2ZW50KFwib25sb2FkXCIsIGNvbXBsZXRlZCk7XG5cbiAgICAgICAgdmFyIHRvcCA9IGZhbHNlO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0b3AgPSB3aW5kb3cuZnJhbWVFbGVtZW50ID09IG51bGwgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50O1xuICAgICAgICB9IGNhdGNoKGUpIHt9XG5cbiAgICAgICAgaWYodG9wICYmIHRvcC5kb1Njcm9sbCkge1xuICAgICAgICAgICAgKGZ1bmN0aW9uIHNjcm9sbENoZWNrKCkge1xuICAgICAgICAgICAgICAgIGlmKHJlYWR5KSByZXR1cm47XG5cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICB0b3AuZG9TY3JvbGwoXCJsZWZ0XCIpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2V0VGltZW91dChzY3JvbGxDaGVjaywgNTApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJlYWR5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBkZXRhY2goKTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICAgICAgfSkoKTtcbiAgICAgICAgfVxuICAgIH1cbn0pKGZ1bmN0aW9uKCl7IGFwcC5pbml0KCk7IH0pOyJdfQ==
